name: ARK Holdings Daily

on:
  schedule:
    - cron: "5 1 * * 1-5"  # ~21:05 US/Eastern on US trading days
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  ark-holdings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download previous baseline artifact
        id: download-baseline
        uses: dawidd6/action-download-artifact@v2
        continue-on-error: true
        with:
          workflow: ark-holdings-daily.yml
          name: ${{ vars.BASELINE_ARTIFACT_NAME }}
          branch: main
          path: baseline

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run daily pipeline
        env:
          EMAIL_ENABLED: ${{ vars.EMAIL_ENABLED }}
          EMAIL_HOST: ${{ vars.EMAIL_HOST }}
          EMAIL_PORT: ${{ vars.EMAIL_PORT }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER }}
          EMAIL_USE_TLS: ${{ vars.EMAIL_USE_TLS }}
          EMAIL_USE_SSL: ${{ vars.EMAIL_USE_SSL }}
          EMAIL_MAX_RETRIES: ${{ vars.EMAIL_MAX_RETRIES }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          FUND_LIST: ${{ vars.FUND_LIST }}
          BASELINE_ARTIFACT_NAME: ${{ vars.BASELINE_ARTIFACT_NAME }}
          BASELINE_DIR: ${{ vars.BASELINE_DIR }}
          OUTPUT_DIR: ${{ vars.OUTPUT_DIR }}
          RETENTION_DAYS: ${{ vars.RETENTION_DAYS }}
          MIN_SHARE_DELTA: ${{ vars.MIN_SHARE_DELTA }}
          MIN_WEIGHT_BP: ${{ vars.MIN_WEIGHT_BP }}
          TIMEZONE: ${{ vars.TIMEZONE }}
          EMAIL_RECIPIENTS_TO: ${{ vars.EMAIL_RECIPIENTS_TO }}
          EMAIL_RECIPIENTS_CC: ${{ vars.EMAIL_RECIPIENTS_CC }}
          EMAIL_RECIPIENTS_BCC: ${{ vars.EMAIL_RECIPIENTS_BCC }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          set -euo pipefail

          BASELINE_NAME="${BASELINE_ARTIFACT_NAME:-ark-holdings-baseline}"
          BASELINE_DIRECTORY="${BASELINE_DIR:-baseline}"
          BASELINE_PATH="baseline/${BASELINE_NAME}/${BASELINE_DIRECTORY}"

          FUND_LIST_CLEAN="$(echo "${FUND_LIST:-}" | tr -d '[:space:]')"
          WEIGHT_THRESHOLD="$(python -c "import os; v=os.environ.get('MIN_WEIGHT_BP','').strip(); bp=int(v) if v.isdigit() else 1; print(bp/10000)")"

          SHARE_THRESHOLD="${MIN_SHARE_DELTA:-1}"

          SEND_EMAIL=false
          if [ -n "${EMAIL_ENABLED:-}" ]; then
            case "${EMAIL_ENABLED,,}" in
              true|yes|1) SEND_EMAIL=true ;;
            esac
          fi

          OUTPUT_DIR_PATH="${OUTPUT_DIR:-temp/ark_pipeline/latest_snapshots}"

          ARGS=(
            --baseline-dir "$BASELINE_PATH"
            --output-dir "$OUTPUT_DIR_PATH"
            --summary-path temp/ark_pipeline/diff_summary.md
            --summary-json temp/ark_pipeline/diff_summary.json
            --recipient-config config/notification_recipients.toml
            --holdings-limit 25
            --weight-threshold "$WEIGHT_THRESHOLD"
            --share-threshold "$SHARE_THRESHOLD"
          )

          if [ -n "$FUND_LIST_CLEAN" ]; then
            ARGS+=(--etfs "$FUND_LIST_CLEAN")
          fi

          if "$SEND_EMAIL"; then
            ARGS+=(--send-email)
          fi

          python py_scripts/ark_holdings/daily_pipeline.py "${ARGS[@]}"

      - name: Publish summary to job log
        run: |
          cat temp/ark_pipeline/diff_summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Prepare artifact payload
        env:
          OUTPUT_DIR: ${{ vars.OUTPUT_DIR }}
        run: |
          set -euo pipefail
          OUTPUT_DIR_PATH="${OUTPUT_DIR:-temp/ark_pipeline/latest_snapshots}"
          mkdir -p artifact
          cp -R "$OUTPUT_DIR_PATH" artifact/baseline
          cp temp/ark_pipeline/diff_summary.md artifact/
          cp temp/ark_pipeline/diff_summary.json artifact/

      - name: Delete previous baseline artifacts
        uses: actions/github-script@v7
        env:
          BASELINE_ARTIFACT_NAME: ${{ vars.BASELINE_ARTIFACT_NAME }}
        with:
          script: |
            const {data} = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });
            for (const artifact of data.artifacts) {
              if (artifact.name === process.env.BASELINE_ARTIFACT_NAME) {
                console.log(`Deleting artifact ${artifact.id} (${artifact.name})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

      - name: Upload baseline artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ vars.BASELINE_ARTIFACT_NAME }}
          path: artifact
          if-no-files-found: error
          retention-days: ${{ vars.RETENTION_DAYS }}
