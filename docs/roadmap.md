# 半人马交易机器人（Centaur Trading Bot）

## 1) 项目目标总揽（Project North Star）
- **定位**：半自动交易系统（Centaur）
- **核心规则**：人类负责**买入决策**；机器人负责**风控 + 自动卖出 + 雷达信号**
- **市场范围**：美股（可扩展到与加密相关的美股，例如 COIN）
- **券商现状/未来**：
  - 当前：Alpaca（paper/live，live 默认关闭需手动开启）
  - 未来：多券商切换（IBKR/Tradier/…）+ 同券商多账号
- **下单风格**：只做 Stop Buy / Stop Sell（外加撤单/改单）
- **明确不做**：
  - 默认不做全自动买入（除非手动开启）
  - 不做高频/HFT

---

## 2) 当前目标（Current Focus: Local Desktop MVP）
目标：**能稳定跑起来 + 不自爆**（可靠 > 功能多）

### 2.1 前端（Frontend / GUI）要达成的效果
- **你能看到的**
  - 账户概览：净值 / 现金 / 购买力 / 当日盈亏
  - 持仓概览：仓位 / 权重 / 盈亏
  - 关注列表行情：last、bid/ask、点差、最后更新时间（实时跳）
  - 订单与成交：状态、成交价/时间、是否已挂保护单
  - 市场状态：盘前/盘中/盘后/休市 + halt 提示（如果能拿到）
- **你能操作的**
  - 生成下单草稿（仅 Stop Buy / Stop Sell）
  - 二次确认后执行
  - 一键清仓（Kill Switch）+ 二次确认
- **当前阶段不做**
  - 复杂图表与高级分析页
  - 盘前动作卡 / 收盘验尸报告（只留入口概念）

### 2.2 后端（Backend / Robot Core）要达成的效果
- **账户与订单事实跟踪**
  - 实时跟踪账户/持仓/订单变化（以券商回报为准）
  - 订单可靠：撤单/改单/挂保护单都要“确认成功”，不允许自嗨
- **成交后自动保护（核心）**
  - 任意 Stop Buy 一旦成交（包括你网页手动下的单），机器人自动挂 **Trailing Stop 卖出保护单**
  - 保护单挂单失败必须告警，并执行一个最小保命降级（先不复杂）
  - 默认规则：Trailing Stop Buy = DAY；Trailing Stop Loss = GTC；extended_hours=false
- **硬风控**
  - Kill Switch：一键清仓/停机
  - 基础风险限制：最大仓位、单笔最大风险（先能挡住大坑）
- **可复盘**
  - 关键动作留痕：发生了什么、系统做了什么、结果如何

### 2.3 Infra（本地运行与依赖）要达成的效果
- 本地桌面运行（个人使用）
- Alpaca only（paper/live，live 默认关闭）
- 允许断线重连、重启恢复状态（不能重启就失忆）
- UI 不直连券商：UI 只读 + 发命令；由后端统一对接券商与行情
- Market data daemon 独占行情 WS（IEX），写入 Redis 热数据层
- 有一个“热数据层”给 UI 秒开（不要求长期存）

---

## 3) Further TODO（暂时不考虑，但要记账）
> 这里放“实现细节/系统设计/高级能力”，当前阶段不展开

- Trade Loop 详细状态机（filled/partial filled 的完整规则）
- 订单状态机 + 幂等键 + 重试策略的工程化细节
- 成交后保护的完整降级策略（trailing 不可用时：stop/stop-limit/flatten 等）
- Trailing Stop 参数策略（从固定 2% → 波动率自适应/按 symbol 分档）
- SSOT 详细表结构（orders/fills/positions/protection_links/trailing_state…）
- Redis key 设计、PubSub/Streams、缓存策略与 TTL
- 行情订阅动态管理（watchlist 增删 / 自动重连 / 限流保护）
- 市场日历/事件系统（Market Calendar / Event Master / 审计版本）
- 外部数据源融合（新闻/事件日历/期权链/公司行为）
- Quiver Quant 策略研究（政策/游说/内线数据驱动）
  1) 策略一：构建“腐败因子”(The Corruption Factor) —— 做多“脏”股票
     - 目标：用多因子思路，将 Quiver 数据聚合为 Corruption_Score。
     - 变量输入：政府合同金额 + 议员持有数量 + 游说投入金额。
     - 操作：做多分数最高 20 只；做空分数最低 20 只。
     - 因果链：政治资源注入 → 非市场优势 → 现金流改善 → Alpha 收益。
  2) 策略二：动态调整止盈止损 (Dynamic Risk Management)
     - 目标：用 Quiver 数据作为置信度权重，动态修改风控阈值。
     - 示例：普通票止损 -3%/止盈 +10%；若 Insider_Holding_Strong 为真，止损放宽到 -8%，止盈上调/取消。
     - 因果链：内幕人士重仓 → 抗跌性增强 → 波动更多为洗盘 → 放宽风控阈值避免被震出。
  3) 策略三：行业轮动预判 (Sector Rotation via Lobbying)
     - 目标：用行业游说支出做板块择时。
     - 触发：某行业游说支出环比激增 >= 50%。
     - 操作：降低其他板块权重，资金倾斜至该行业并择优选股。
     - 因果链：游说加码 → 政策预期变化 → 板块基本面重塑 → 资金流入。
  4) 策略四：避雷针 (Blacklist Filter)
     - 目标：用内部人卖出作为买入的一票否决。
     - 规则：若 C-Level 近 3 个月净卖出 > 100 万美元，取消买入信号。
     - 理由：技术图形可能是掩护出货，避免接盘。
- 事件“含金量/惊吓程度”策略研究（预期差驱动）
  - 指标一：Pre-Event Price Drift（消息前抢跑幅度）
    - 计算：消息前 5 天至发布前 1 分钟，算 CAR（累积超额收益）。
    - 判定：CAR > 5% 且利好 → 已消化（卖事实/反手）；CAR < -2% 且利好 → 高含金量（追随）。
  - 指标二：Implied Volatility（IV_Rank）
    - 判定：IV_Rank > 90% 视为市场已充分预期，利好门槛提高，谨防 IV Crush。
  - 指标三：Standardized Surprise（Z-Score）
    - 数据：接财经日历/一致预期，计算 (Actual - Consensus) / Std。
    - 判定：Z > 2.0 追随；0.5 < Z < 2.0 观望。
  - 反应测试：Price Reaction Check
    - 规则：T0 记录价；T+1min 冲高；T+5min 跌破 T0 视为“利好兑现”，触发反向。
- 财报“利好出尽”策略研究（预期阈值与流动性陷阱）
  - 伪门槛：Whisper Number（真实及格线）
    - 说明：分析师共识可能刻意偏低，真正市场阈值更高。
    - 规则：若实际值虽超共识但低于隐含阈值，则偏空处理。
  - Guidance 优先级：前瞻指引比历史财报更重要
    - 规则：当财报好但指引下调时，按“未来恶化”处理。
  - 流动性出口：财报日是大机构出货窗口
    - 规则：若财报日成交量放大且股价冲高回落，标记为分发。
  - 盘前抢跑：Pre-Earnings Run-up
    - 计算：近 20 天涨幅（Run_up）。
    - 规则：Run_up > 15% 且 Z-Score <= 3 → 倾向卖事实/反向。
  - NLP 情绪与“怂词”计数
    - 数据：财报电话会议文本。
    - 规则：负向词频环比上升则降低持仓或取消追单。
  - 增长减速：关注二阶导数
    - 规则：增长率下降（减速）时提高风险权重。
  - 行为统计：历史“赢了数字输了股价”
    - 规则：统计近 8 次财报中“超预期但股价下跌”的次数，高频则财报前降仓/清仓。
- 多券商、多账号
- 回测框架/策略研究流水线
- 报表：盘前动作卡 / 收盘验尸报告
- CFD OCO 
  - 支持双向持仓），
  - 加上“时间过滤器” (Time Filter)
  - 用 3Commas 这种高级货。
---

## 4) Constraints（限制与已知坑，统一放最后）
- 免费 IEX 行情：订阅 symbols 数量有限（例如 <=30）
- 行情 WebSocket 连接数受限（通常 1 条），需要单连接复用
- 不同交易时段（盘前/盘后/夜盘）对订单类型有约束：某些单可能挂不上/不触发
- Trailing Stop 触发后成交方式可能带滑点（风险提示必须展示）
- Redis 只做热数据/公告栏，不当真账本；关键事实必须能复盘
