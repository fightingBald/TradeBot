# 半人马交易机器人（Half‑Automated / Centaur）— README（协作版 Spec）

> **核心思想**：人类负责**买入决策**；机器人负责**风控 + 自动卖出 + 雷达信号**。
>
> **核心目标**：先保命，再赚钱。
>
> **市场**：美股（可选扩展到与加密相关的美股，例如 COIN）。
>
> **券商**：Alpaca（当前在用），架构上必须支持 **多券商切换**（如 IBKR/Tradier/…）与 **同券商多账号**（Paper/Real、多子账户）。
>
> **下单风格**：只做 **Stop Buy / Stop Sell**（外加撤单/改单）。

---

## 0. 一页速读

### 机器人【会做】

* 监控行情 + 事件日历 + 期权链快照（尽力，拿不到就说拿不到）。
* 产出两份“作战卡”：**盘前动作卡**、**收盘验尸报告**（伦敦时间）。
* 执行硬风控：**自动卖出 / 降仓 / 停机**。
* 维护严格的**订单状态机**，防止“撤单未成功却以为释放资金”导致破产。
* 提供 GUI（批量操作：调仓、清仓、狙击下单草稿）。

### 机器人【不做】

* 默认不做全自动买入（除非你明确打开开关）。
* 不做高频/HFT。
* 不承诺预测未来。
* 不自动下单交易流动性差的期权（默认只用于分析/避雷）。

### 当前阶段（Local Desktop MVP）

* 本地桌面运行，Alpaca 单券商（paper/live）。
* 可视化持仓分布（仓位/权重/盈亏）。
* GUI 一键清仓（Kill Switch）+ 二次确认。
* 暂不接入外部数据源，仅用券商账户/持仓数据。
* 存储先本地轻量化，但保留 StoragePort 接口以便未来接外部 DB。
* 结构化日志 + 关键风控动作留痕。

---

## 1. 标的清单（Watchlist / Holdings）

AMD, ASML, AVGO, BULL, COIN, CRCL, CRWV, FIG, GOOGL, HOOD, IBKR, ICE, META, MRVL, NBIS, NFLX, NVDA, OKLO, ORCL, PEP, PLTR

---

## 2. 角色分工（Centaur 模式）

### 人类（司令官）

* 最终批准 **买入**。
* 需要时手动解锁冷却期。
* 设定目标仓位/风险上限/执行偏好。

### 机器人（保镖 + 雷达）

* 自动风控：卖出/减仓/撤单/停机。
* 生成 Top 3 / Top 6 异常名单与触发条件。
* 按计划定时生成日报并推送。
* 默认**不在无人确认情况下增加风险敞口**。

---

## 3. 高层架构（模块划分）

> ✅ 新增硬要求：**多券商 + 多账号 + Paper/Real 切换**，以及 **数据源插件化**（随时加新数据源不改核心）。

1. **ingestion/**（水管）

* 从 IBKR + 公开源抓：价格、指数、日历、期权快照、另类数据。

2. **normalize/**（统一口径）

* 对齐时间、标的映射、公司行为（拆股等）、字段校验。

3. **storage/**（仓库）

* 存原始数据 + 衍生特征 + 决策记录 + 订单/成交。

4. **features/**（切菜）

* 把原始输入变成稳定“人话指标”（内部可以算，输出不写公式）。

5. **signals/**（雷达 + 打分）

* 置信分/异常检测/Top‑K 选择。

6. **risk/**（保命核心）

* 账户回撤、单票限制、冷却期、流动性护栏、Kill Switch。

7. **execution/**（手 + 刹车）

* 券商接口、订单状态机、撤单/改单、卖出执行策略。

8. **reporting/**（军报）

* 盘前动作卡 + 收盘验尸报告 + 推送。

9. **ui/**（武器库）

* Streamlit（优先）GUI：调仓/清仓/狙击/解锁冷却。

10. **observability/**（黑匣子）

* 结构化日志、指标、告警、可回放。

---

## 4. 多券商 / 多账号 / 环境切换（必做，别装死）

> 你的现实：现在用 **Alpaca**，未来想在不同券商之间切换；同一个券商下还要同时跑 **Paper Trading** 和 **Real Trading**（甚至多个账号/子账户）。

### 4.1 核心抽象：Trading Profile（交易配置档）

系统必须支持用一个“档案”来定义：

* 用哪个券商（alpaca / ibkr / …）
* 用哪个账号（account_id）
* 用哪个环境（paper / live）
* 风控参数（最大回撤、单票上限等）
* 允许的功能（是否允许自动卖出、是否允许下单、是否允许某些订单类型）

> 机器人所有动作都必须带上 `profile_id`，不然你迟早把真仓当模拟仓砍了。

* Phase 0A：可以只有一个 profile，但 `profile_id` 仍是必填字段（便于未来扩展）。

### 4.2 Broker Adapter（券商适配器）

执行层必须变成“插拔式”：

* `BrokerAdapter`：统一接口（下单、撤单、查持仓、查资金、拉成交回报、行情订阅/快照）
* `Capabilities`：每个券商能干啥要显式声明（支持 stop / trailing / OCO / short / fractional / extended hours…）
* `OrderNormalizer`：把“统一订单模型”映射到具体券商订单模型

**统一订单模型（必须字段）**

* `profile_id`（关键）
* `broker`（alpaca/…）
* `account_id`
* `environment`（paper/live）
* `symbol`
* `side`（buy/sell）
* `type`（stop/market/limit/…）
* `qty`
* `time_in_force`
* `client_order_id`（全局唯一，用来对账和防重）

### 4.3 Account Router（账号路由器）

* 所有下单、撤单、查询动作都先过 `AccountRouter(profile_id)`
* Router 负责拿到正确的 adapter + credentials + 风控策略
* Router 必须支持：

    * **运行时切换 profile**（GUI 选纸仓/真仓/不同账号）
    * **并行运行多个 profile**（比如 paper 跑策略，live 只做风控卖出）

### 4.4 安全与防呆（不做你就等着翻车）

* `paper` 和 `live` 必须在 UI 上用**极端对比**标识（颜色/大字/二次确认）
* live 下单必须有 **2-step confirm**（至少一次“我确认这是 live”）
* 每笔订单写入 DB 时必须记录 `profile_id + broker + account_id + environment`
* 日志、报告、推送消息必须显示环境（paper/live），别让你在厕所里一按按钮把真仓清了。

---

## 5. 数据源插件化（随时加“情报”，核心不改）

> 目标：你未来想加 earnings / insider / congress / coinglass / polymarket / 期权链 / 新闻… **都只加插件**，不去改核心逻辑。

* Phase 0A：暂不接入外部数据源，仅保留接口定义或空实现。

### 5.1 DataSource Plugin（数据源插件）

每个数据源是一个插件，必须实现：

* `name` / `version`
* `fetch(window, symbols)`：拉数据
* `schema()`：输出字段定义（JSON schema 或 pydantic model）
* `quality()`：新鲜度/缺失率/错误率（用来做降级）

### 5.2 Registry + Feature Bus（注册表 + 特征总线）

* `DataSourceRegistry`：按配置加载启用的插件
* `FeatureBus`：所有插件输出统一丢到总线里（按 symbol/time_key 组织）
* 下游（signals/risk/reporting）只消费 FeatureBus，不关心数据从哪来

### 5.3 降级规则（必须写死）

* 任一插件挂了：

    * 风控照常跑
    * 信号/报告对缺失字段标记 `UNAVAILABLE`
    * 置信分自动下调（别因为缺数据反而更自信）

---

## 6. 数据源清单（以及在系统里干啥）

> 原则：**数据越多不等于越聪明**。系统必须支持“缺数据也不发疯”。

### 4.1 必须可用（MVP 必备）

* **券商账户状态**：持仓、现金/购买力、挂单、成交回报。
* **行情价格**：标的价格（分钟级/快照即可）+ 关键指数（SPX/NDX 代理）+ VIX 代理。

### 4.2 事件日历（地雷开关）

* 财报日历（按标的）。
* 宏观日历（CPI/FOMC/就业等）。

### 4.3 期权链（雷达，不是方向盘；尽力快照）

* 近月 ATM **IV 变化**（保险费涨没涨）。
* **Put/Call** 成交量比（情绪偏向）。
* **OI 集中价位**（磁铁区/钉子价候选）。

> **强制规则**：拿不到/不可靠 → 输出 **UNAVAILABLE**，禁止编。

### 4.4 另类数据（可选；必须可降级）

* Insider trades
* 国会议员持仓
* Coinglass（加密杠杆压力）
* Polymarket（叙事概率温度）

---

## 5. 核心交易策略（政策级规则）

### 5.1 允许的订单类型

* **Stop Buy**（人类确认后提交）
* **Stop Sell**（机器人管理）
* Cancel / Replace（撤单/改单，机器人管理）

### 5.2 买入策略（默认）

* 机器人只给：**建议 + 触发条件 + 仓位建议区间**。
* 人类在 GUI 点确认 → 提交 **Stop Buy** 草稿。

### 5.3 卖出策略（自动）

触发任一条件即可执行（优先级从上到下）：

1. **单票硬止损触发**
2. **组合回撤触发**（账户层面）
3. **事件停机触发**（重大宏观/财报窗口）
4. **流动性恶化触发**（价差/深度异常）

---

## 6. 风控引擎（写死，不讲情面）

### 6.1 组合层面

* **日内最大回撤**：超阈值 → 自动降仓/清仓 + 当天停机。
* **总风险敞口上限**：防止杠杆/满仓。
* **主题相关性上限**：避免一堆半导体同归于尽。

### 6.2 单票层面

* **单票最大仓位**。
* **硬止损 /（可选）移动止损**。
* **冷却期 Cool‑down**：触发强制卖出后默认 24h 禁止再上（除非 GUI 手动解锁）。

### 6.3 流动性护栏

* 如果价差/深度超过阈值：

    * 禁止新增风险
    * 只允许减仓/平仓
    * 卖出优先选择“能出去”的执行方式

### 6.4 Kill Switch（核按钮）

* 取消全部挂单
* 平掉全部持仓（转现金）
* 停机

---

## 7. 订单状态机（防破产必备）

每个订单必须遵循：

`PendingNew -> Open -> PendingCancel -> (Cancelled | Filled | PartiallyFilled)`

硬规则：

* **资金只有在收到 Cancelled 回执后才算释放**。
* Cancel 若返回“已成交”，必须更新为 Filled/Partial，并阻止后续依赖动作。

---

## 8. 市场状态识别（Regime Router：先看路况再开车）

市场分三种状态：

* `SLEEP`（睡觉盘）：震荡磨叽，假突破多
* `TREND`（趋势盘）：更可能有延续
* `MANIA`（疯狗盘）：波动爆炸/事件日，先保命

用途：

* 决定当天是否允许突破类建议
* 调整仓位上限与止损策略
* 大事件窗口触发 no‑trade

---

## 9. 信号与置信分（不搞学术，搞可执行）

每个标的每天一个 **0–100** 分，来自三块：

* **口碑分**：这招在类似路况历史上靠谱不靠谱
* **天气分**：今天的路况适不适合
* **汽油分**：有没有燃料（量能/指数同向/事件风险/期权情绪雷达）

输出：

* 盘前：Top 3
* 盘后：Top 6

---

## 10. 定时输出（伦敦时间）

### 10.1 盘前动作卡（周一到周五 13:30）

必须包含：

* Top 3：为什么会搞事 + 可执行触发条件
* 今日地雷表（宏观/财报/监管）
* 风险分桶：火药桶 / 滚刀肉 / 老狗
* Top 3 期权/情绪快照（或 UNAVAILABLE）

### 10.2 收盘验尸报告（周一到周五 21:25）

必须包含：

1. 今日一句话事故通报
2. 大盘怎么抽风（指数/波动/利率/美元/油；用“谁掏钱谁挨打”讲）
3. Top 6 最异常：发生→钱流→明天两剧本→动作
4. 全列表快扫（红黄绿 + 触发器）
5. 期权链快照（可得则报，不可得写 UNAVAILABLE）
6. 明天地雷表（伦敦时间）
7. 调仓操作手册（必须/可以/禁止各≤3）
8. 风险提示：非投资建议

---

## 11. GUI 需求（Streamlit 优先）

### 必备按钮/页面

* **Rebalance（一键平衡）**：按目标权重算差额 → 生成订单草稿 → 人类确认
* **Panic（一键清仓）**：触发 Kill Switch
* **Sniper（狙击模式）**：选标的 + 预算（% 或 $）→ 生成 Stop Buy 草稿 +（可选）保护性止损草稿
* **Unlock（解锁冷却）**：人类显式授权
* **Orders（订单面板）**：挂单/成交/风险旗标/净值/暴露

---

## 12. 存储与日志（黑匣子）

* Phase 0A：先本地落地（SQLite/JSONL 均可），对外暴露 StoragePort 接口；日志采用结构化格式并包含 `profile_id`、环境与动作类型。

### 最小表/集合

* `positions_snapshots`
* `orders`（包含状态机字段）
* `fills`
* `risk_events`
* `signals_daily`
* `reports_pre_market`
* `reports_post_close`
* `data_quality_events`

### 决策可追溯

每次输出/动作必须记录：

* 时间戳
* 输入数据源 + 新鲜度
* 输出结论/动作
* 风控检查通过/失败原因

---

## 13. 降级与安全（缺数据也别发疯）

* 任一数据源失败：

    * 风控仍要可用
    * 报告中对应字段标记 UNAVAILABLE
    * 禁止“编数字”
* 券商 API 不稳定：

    * fail‑closed（宁可停机）
    * 推送通知人类

---

## 14. MVP 里程碑（野蛮启动）

### Phase 0A（Local Desktop MVP）

* Alpaca 连接（单券商）+ Trading Profile 最小实现。
* 可视化持仓分布（本地 GUI）。
* GUI 一键清仓（Kill Switch）+ live 二次确认。
* 订单状态机最小闭环（下单/撤单/成交同步）。
* 本地落库/日志留痕（未来可替换为外部 DB）。

### Phase 0（先活）

* BrokerAdapter 抽象 + 第二券商接入（如 IBKR）。
* 多账号拉持仓/现金/挂单。
* 自动卖出触发。
* Kill Switch。
* 订单状态机强化（撤单/改单/幂等/回执对账）。

### Phase 1（能盯）

* 盘前动作卡 + 收盘验尸
* Top 3/Top 6 打分（最少特征）
* 推送

### Phase 2（更像机构）

* Regime Router
* 期权快照接入
* GUI 调仓/狙击
* 回放工具 + 指标面板

---

## 15. 风险提示

本系统**不是投资建议**。可能因跳空、滑点、流动性枯竭、API 宕机、黑天鹅导致不可控损失。

> **优先级：先保命，再赚钱。**
